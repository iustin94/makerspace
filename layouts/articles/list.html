{{ define "main" }}
<section class="py-16">
  <div class="container mx-auto px-4">
    <h1 class="text-secondary mb-8 text-center font-secondary text-4xl font-bold xl:text-6xl">{{ .Title }}</h1>
    {{ with .Params.description }}
      <p class="mx-auto mb-12 text-center text-gray-dark xl:max-w-[50%]">{{ . }}</p>
    {{ end }}

    <!-- Search & Tag Filters -->
    <div class="mx-auto mb-10 max-w-4xl">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center">
        <div class="relative flex-1">
          <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-secondary-2 text-sm"></i>
          <input
            type="search"
            id="article-search"
            placeholder="{{ i18n "search_by_title" }}"
            class="w-full rounded-[10px] border border-primary-2 py-2.5 pl-10 pr-4 text-sm focus:border-accent focus:outline-none"
          />
        </div>
      </div>

      {{/* Collect all unique tags */}}
      {{ $allTags := slice }}
      {{ range .Pages }}
        {{ with .Params.tags }}
          {{ range . }}
            {{ $allTags = $allTags | append . }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ $allTags = $allTags | uniq | sort }}

      {{ if $allTags }}
        <div class="mt-4 flex flex-wrap gap-2" id="tag-filters">
          <button
            class="tag-btn active rounded-full border border-accent bg-accent px-3 py-1 text-xs font-medium text-white transition-colors duration-200 cursor-pointer"
            data-tag="all"
          >{{ i18n "all" }}</button>
          {{ range $allTags }}
            <button
              class="tag-btn rounded-full border border-primary-2 bg-white px-3 py-1 text-xs font-medium text-gray-dark transition-colors duration-200 cursor-pointer hover:border-accent hover:text-accent"
              data-tag="{{ . | lower }}"
            >{{ . }}</button>
          {{ end }}
        </div>
      {{ end }}
    </div>

    <!-- Article Cards -->
    <div class="mx-auto max-w-4xl flex flex-col gap-8" id="article-list">
      {{ range .Pages.ByDate.Reverse }}
        <a
          href="{{ .RelPermalink }}"
          class="article-card group flex flex-col overflow-hidden rounded-[10px] border border-gray-200 bg-white shadow-sm transition-all duration-200 hover:border-accent hover:shadow-md md:flex-row"
          data-title="{{ .Title | lower }}"
          data-tags="{{ with .Params.tags }}{{ delimit . "," | lower }}{{ end }}"
        >
          {{/* Cover image */}}
          {{ with .Params.cover }}
            {{ $img := resources.Get . }}
            {{ with $img }}
              {{ $card := .Fill "600x400 q80" }}
              <div class="aspect-[3/2] w-full shrink-0 overflow-hidden md:aspect-auto md:w-64">
                <img
                  src="{{ $card.RelPermalink }}"
                  alt="{{ $.Title }}"
                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
            {{ end }}
          {{ end }}
          <div class="flex flex-1 flex-col justify-center p-6">
            <div class="mb-2 flex flex-wrap items-center gap-3 text-sm text-secondary-2">
              <time datetime='{{ .Date.Format "2006-01-02" }}'>{{ .Date.Format "January 2, 2006" }}</time>
              {{ with .Params.author }}
                <span>&middot; {{ . }}</span>
              {{ end }}
              {{ with .Params.reading_time }}
                <span>&middot; {{ . }} {{ i18n "min_read" }}</span>
              {{ end }}
            </div>
            <h2 class="article-title text-secondary mb-2 font-secondary text-xl font-bold group-hover:text-accent duration-200">{{ .Title }}</h2>
            {{ with .Params.description }}
              <p class="text-sm text-gray-dark line-clamp-2">{{ . }}</p>
            {{ end }}
            {{ with .Params.tags }}
              <div class="mt-3 flex flex-wrap gap-2">
                {{ range . }}
                  <span class="bg-primary rounded-full px-2.5 py-0.5 text-xs text-gray-dark">{{ . }}</span>
                {{ end }}
              </div>
            {{ end }}
          </div>
        </a>
      {{ end }}
    </div>

    <!-- No results message -->
    <p id="no-results" class="mx-auto mt-8 hidden max-w-4xl text-center text-gray-dark">{{ i18n "no_articles_match" }}</p>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('article-search');
  const cards = document.querySelectorAll('.article-card');
  const tagBtns = document.querySelectorAll('.tag-btn');
  const noResults = document.getElementById('no-results');
  let activeTag = 'all';

  function filterArticles() {
    const query = searchInput.value.toLowerCase().trim();
    let visible = 0;

    cards.forEach(function(card) {
      const title = card.dataset.title;
      const tags = card.dataset.tags;
      const matchesSearch = !query || title.includes(query);
      const matchesTag = activeTag === 'all' || tags.split(',').indexOf(activeTag) !== -1;

      if (matchesSearch && matchesTag) {
        card.style.display = '';
        visible++;
      } else {
        card.style.display = 'none';
      }
    });

    noResults.classList.toggle('hidden', visible > 0);
  }

  searchInput.addEventListener('input', filterArticles);

  tagBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      tagBtns.forEach(function(b) {
        b.classList.remove('active', 'bg-accent', 'text-white', 'border-accent');
        b.classList.add('bg-white', 'text-gray-dark', 'border-primary-2');
      });
      btn.classList.add('active', 'bg-accent', 'text-white', 'border-accent');
      btn.classList.remove('bg-white', 'text-gray-dark', 'border-primary-2');
      activeTag = btn.dataset.tag;
      filterArticles();
    });
  });
});
</script>
{{ end }}
