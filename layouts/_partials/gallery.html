{{/* Gallery Partial */}}
{{/* Usage: {{ partial "gallery.html" . }} */}}
{{/* Expects .Params.gallery to be a path like "images/workspace/3dprinters" */}}

{{ with .Params.gallery }}
  {{ $pattern := printf "%s/*" . }}
  {{ $images := resources.Match $pattern }}
  {{ if $images }}
  <div class="mt-16">
    <h2 class="mb-8 text-center font-secondary text-3xl font-bold text-secondary">Gallery</h2>

    <!-- Thumbnail Grid -->
    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
      {{ range $index, $img := $images }}
        {{ $thumb := $img.Fill "400x300 q80" }}
        <button
          onclick="openGallery({{ $index }})"
          class="group relative aspect-[4/3] overflow-hidden rounded-[10px] focus:outline-none focus:ring-2 focus:ring-accent"
        >
          <img
            src="{{ $thumb.RelPermalink }}"
            alt="{{ $.Title }} gallery image {{ add $index 1 }}"
            class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
          />
          <div class="absolute inset-0 bg-secondary/0 transition-all duration-300 group-hover:bg-secondary/20"></div>
        </button>
      {{ end }}
    </div>

    <!-- Lightbox Modal -->
    <div
      id="gallery-lightbox"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4"
      onclick="if(event.target===this)closeGallery()"
    >
      <!-- Dialog Card -->
      <div class="relative mx-auto flex max-h-[90vh] w-full max-w-5xl flex-col overflow-hidden rounded-[10px] border-4 border-accent bg-white shadow-2xl">
        <!-- Close Button -->
        <button
          onclick="closeGallery()"
          class="absolute right-3 top-3 z-10 rounded-full bg-secondary/80 p-2 text-white transition-colors hover:bg-secondary"
          aria-label="Close gallery"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <!-- Image Area -->
        <div class="relative flex min-h-0 flex-1 items-center justify-center bg-primary p-4">
          <!-- Previous Button -->
          <button
            onclick="prevImage()"
            class="absolute left-3 top-1/2 z-10 -translate-y-1/2 rounded-full bg-secondary/80 p-2.5 text-white transition-colors hover:bg-secondary"
            aria-label="Previous image"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <img
            id="gallery-lightbox-img"
            src=""
            alt=""
            class="max-h-[60vh] max-w-full rounded-[10px] object-contain"
          />

          <!-- Next Button -->
          <button
            onclick="nextImage()"
            class="absolute right-3 top-1/2 z-10 -translate-y-1/2 rounded-full bg-secondary/80 p-2.5 text-white transition-colors hover:bg-secondary"
            aria-label="Next image"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        <!-- Description Footer -->
        <div class="border-t border-gray-200 bg-white px-6 py-4">
          <div class="flex items-center justify-between gap-4">
            <p id="gallery-lightbox-desc-text" class="text-sm text-gray-dark leading-relaxed"></p>
            <span id="gallery-counter" class="shrink-0 text-sm font-medium text-secondary-2"></span>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function() {
        const images = [
          {{ range $img := $images }}
            {{ $full := $img.Fit "1600x1200 q90" }}
            "{{ $full.RelPermalink }}",
          {{ end }}
        ];
        const descriptions = [
          {{ $meta := $.Params.gallery_meta }}
          {{ range $img := $images }}
            {{ $name := path.Base $img.Name }}
            {{ if and $meta (index $meta $name) }}"{{ (index $meta $name).description }}"{{ else }}""{{ end }},
          {{ end }}
        ];
        let currentIndex = 0;
        const lightbox = document.getElementById('gallery-lightbox');
        const lightboxImg = document.getElementById('gallery-lightbox-img');
        const counter = document.getElementById('gallery-counter');
        const descText = document.getElementById('gallery-lightbox-desc-text');

        function showImage(index) {
          currentIndex = (index + images.length) % images.length;
          lightboxImg.src = images[currentIndex];
          lightboxImg.alt = '{{ $.Title }} gallery image ' + (currentIndex + 1);
          counter.textContent = (currentIndex + 1) + ' / ' + images.length;
          descText.textContent = descriptions[currentIndex] || '';
        }

        window.openGallery = function(index) {
          showImage(index);
          lightbox.classList.remove('hidden');
          lightbox.classList.add('flex');
          document.body.style.overflow = 'hidden';
        };

        window.closeGallery = function() {
          lightbox.classList.add('hidden');
          lightbox.classList.remove('flex');
          document.body.style.overflow = '';
        };

        window.nextImage = function() { showImage(currentIndex + 1); };
        window.prevImage = function() { showImage(currentIndex - 1); };

        document.addEventListener('keydown', function(e) {
          if (lightbox.classList.contains('hidden')) return;
          if (e.key === 'Escape') closeGallery();
          if (e.key === 'ArrowRight') nextImage();
          if (e.key === 'ArrowLeft') prevImage();
        });
      })();
    </script>
  </div>
  {{ end }}
{{ end }}